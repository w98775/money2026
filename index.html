<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大樓財務管理系統 v4.6 (清空版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: "Noto Sans TC", sans-serif; background-color: #f3f4f6; padding-bottom: 120px; }
        .hidden-tab { display: none; }
        .floating-calc {
            position: fixed; bottom: 20px; right: 20px; width: 220px;
            background-color: #1f2937; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100;
            padding: 10px; transform: scale(0.9); transform-origin: bottom right;
        }
        .calc-btn { height: 40px; font-size: 1rem; transition: all 0.1s; }
        .calc-btn:active { transform: scale(0.95); }
        .calc-display {
            background-color: #111827; color: #4ade80; font-family: monospace;
            font-size: 1.5rem; text-align: right; padding: 8px;
            border-radius: 6px; margin-bottom: 10px;
        }
        .calc-toggle {
            position: absolute; top: -30px; right: 0; background: #1f2937;
            color: white; padding: 4px 12px; border-radius: 6px 6px 0 0;
            cursor: pointer; font-size: 0.8rem;
        }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .balance-card { animation: fadeInDown 0.5s ease-out; }
        .editing-mode { border: 2px solid #f59e0b; background-color: #fffbeb; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); display: flex;
            justify-content: center; align-items: center; z-index: 999;
        }
        .modal-content {
            background: white; padding: 24px; border-radius: 12px;
            width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

    <header class="bg-indigo-900 text-white p-4 shadow-md sticky top-0 z-40">
        <div class="flex justify-between items-center max-w-3xl mx-auto">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-building-columns mr-2"></i>大樓財務管理</h1>
            <div class="flex items-center gap-2">
                <button id="headerSyncBtn" onclick="handleSyncClick()" class="flex items-center gap-2 px-3 py-1.5 rounded bg-indigo-800 border border-indigo-600 hover:bg-indigo-700 transition text-sm shadow-sm">
                    <i id="syncIcon" class="fa-solid fa-cloud"></i> 
                    <span id="headerSyncText">連線中...</span>
                </button>
                <button onclick="openSettingsModal()" class="text-indigo-300 hover:text-white px-2 transition" title="設定與資料救援">
                    <i class="fa-solid fa-gear text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto p-4 space-y-6">
        <div class="balance-card bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-5 rounded-xl shadow-lg flex justify-between items-center">
            <div>
                <p class="text-indigo-100 text-sm font-medium mb-1">大樓零用金餘額</p>
                <p class="text-4xl font-bold tracking-tight" id="totalBalanceDisplay">计算中...</p>
            </div>
            <div class="text-5xl text-white opacity-20"><i class="fa-solid fa-coins"></i></div>
        </div>

        <div id="editModeBanner" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded shadow-md flex justify-between items-center">
            <div>
                <p class="font-bold"><i class="fa-solid fa-pen-to-square"></i> 正在修改資料</p>
                <p class="text-sm">請修改下方表單內容，完成後點擊「確認修改」。</p>
            </div>
            <button onclick="cancelEdit()" class="bg-white text-yellow-700 border border-yellow-500 px-3 py-1 rounded text-sm hover:bg-yellow-50">取消</button>
        </div>

        <div class="grid grid-cols-4 gap-2 bg-white p-1 rounded-lg shadow">
            <button onclick="switchTab('fee')" id="btn-fee" class="tab-btn py-2 text-sm font-medium rounded-md bg-indigo-100 text-indigo-700">管理費</button>
            <button onclick="switchTab('parking')" id="btn-parking" class="tab-btn py-2 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-50">車位租借</button>
            <button onclick="switchTab('misc')" id="btn-misc" class="tab-btn py-2 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-50">雜支</button>
            <button onclick="switchTab('records')" id="btn-records" class="tab-btn py-2 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-50">流水明細</button>
        </div>

        <div id="tab-fee" class="tab-content bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">繳納管理費</h2>
            <form onsubmit="handleSubmit(event, '管理費')" id="form-fee" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700">戶號</label><input type="text" name="unit" required placeholder="3-2" class="mt-1 block w-full rounded border p-2"></div>
                    <div><label class="block text-sm font-medium text-gray-700">繳納年度</label><select name="period" class="mt-1 block w-full rounded border p-2 bg-white"><option value="115-上">115-上年度</option><option value="115-下">115-下年度</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700">繳納日期</label><input type="date" name="date" class="date-input mt-1 block w-full rounded border p-2" required></div>
                    <div><label class="block text-sm font-medium text-gray-700">金額</label><input type="number" name="amount" value="4800" readonly class="mt-1 block w-full rounded border p-2 bg-gray-100 cursor-not-allowed"></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700">帳號後三碼</label><input type="text" name="last3" maxlength="5" placeholder="123" class="mt-1 block w-full rounded border p-2"></div>
                <button type="submit" class="submit-btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow"><i class="fa-solid fa-check mr-2"></i>提交管理費</button>
            </form>
        </div>

        <div id="tab-parking" class="tab-content hidden-tab bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">車位租借登記</h2>
            <form onsubmit="handleSubmit(event, '車位租借')" id="form-parking" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700">車位號碼</label><select name="unit" id="parkingSpotSelect" onchange="updateParkingPrice()" class="mt-1 block w-full rounded border p-2 bg-white" required><option value="" disabled selected>請選擇</option><option value="8">8號</option><option value="11">11號</option><option value="31">31號</option><option value="32">32號</option><option value="33">33號</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700">租借人</label><input type="text" name="renter" required placeholder="如: 2-2" class="mt-1 block w-full rounded border p-2"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700">匯款日期</label><input type="date" name="date" class="date-input mt-1 block w-full rounded border p-2" required></div>
                    <div><label class="block text-sm font-medium text-gray-700">金額</label><input type="number" name="amount" id="parkingPrice" readonly class="mt-1 block w-full rounded border p-2 bg-gray-100"></div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700">帳號後三碼</label><input type="text" name="last3" maxlength="5" placeholder="081" class="mt-1 block w-full rounded border p-2"></div>
                <button type="submit" class="submit-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow"><i class="fa-solid fa-car mr-2"></i>登記車位</button>
            </form>
        </div>

        <div id="tab-misc" class="tab-content hidden-tab bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">雜支紀錄</h2>
            <form onsubmit="handleSubmit(event, '雜支')" id="form-misc" class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">日期</label><input type="date" name="date" class="date-input mt-1 block w-full rounded border p-2" required></div>
                <div><label class="block text-sm font-medium text-gray-700">摘要</label><input type="text" name="summary" required placeholder="如：購買燈泡" class="mt-1 block w-full rounded border p-2"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700">收入</label><input type="number" name="income" placeholder="0" class="mt-1 block w-full rounded border p-2"></div>
                    <div><label class="block text-sm font-medium text-gray-700">支出</label><input type="number" name="expense" placeholder="0" class="mt-1 block w-full rounded border p-2"></div>
                </div>
                <button type="submit" class="submit-btn w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow"><i class="fa-solid fa-pen-to-square mr-2"></i>記錄雜支</button>
            </form>
        </div>

        <div id="tab-records" class="tab-content hidden-tab bg-white p-4 rounded-lg shadow-md">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 border-b pb-2 gap-2">
                <h2 class="text-lg font-bold text-gray-800">流水明細</h2>
                <div class="flex flex-wrap items-center gap-2">
                    <input type="month" id="monthFilter" onchange="renderRecords()" class="border rounded px-2 py-1 text-sm text-gray-700">
                    <div class="flex space-x-1 bg-gray-100 p-1 rounded">
                        <button onclick="filterRecords('all')" id="filter-all" class="filter-btn px-3 py-1 text-xs font-bold rounded bg-white shadow text-indigo-600">全部</button>
                        <button onclick="filterRecords('管理費')" id="filter-fee" class="filter-btn px-3 py-1 text-xs rounded text-gray-500">管理費</button>
                        <button onclick="filterRecords('車位租借')" id="filter-parking" class="filter-btn px-3 py-1 text-xs rounded text-gray-500">車位</button>
                        <button onclick="filterRecords('雜支')" id="filter-misc" class="filter-btn px-3 py-1 text-xs rounded text-gray-500">雜支</button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 py-2 text-left">日期</th><th class="px-2 py-2 text-left">摘要</th><th class="px-2 py-2 text-right">收入</th><th class="px-2 py-2 text-right">支出</th><th class="px-2 py-2 text-right">結餘</th><th class="px-2 py-2 text-left">後三碼</th><th class="px-2 py-2 text-center">狀態</th><th class="px-2 py-2 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div id="noDataMsg" class="text-center text-gray-400 py-8 hidden">無符合資料</div>
        </div>
    </main>

    <div id="settingsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2 text-gray-800">⚙️ 設定與救援</h3>
            <p class="mb-1 text-xs text-gray-500">Apps Script 網址：</p>
            <input type="text" id="gasUrlInput" class="w-full border rounded p-2 mb-4 text-xs">
            
            <button onclick="cleanDuplicates()" class="w-full mb-3 px-3 py-2 text-xs bg-green-100 text-green-700 rounded border border-green-300 font-bold hover:bg-green-200">
                <i class="fa-solid fa-broom"></i> 清除重複資料
            </button>

            <button onclick="deleteUnsyncedRecords()" class="w-full mb-3 px-3 py-2 text-xs bg-red-100 text-red-700 rounded border border-red-300 font-bold hover:bg-red-200">
                <i class="fa-solid fa-trash-can"></i> 刪除未同步資料 (捨棄本機修改)
            </button>

            <button onclick="forceDownload()" class="w-full mb-3 px-3 py-2 text-xs bg-blue-100 text-blue-700 rounded border border-blue-300 font-bold hover:bg-blue-200">
                <i class="fa-solid fa-cloud-arrow-down"></i> 強制從雲端抓回資料 (救援)
            </button>
            <div class="flex justify-between gap-2 border-t pt-3">
                <button onclick="resetSyncStatus()" class="text-xs text-red-500 hover:underline">重置狀態</button>
                <div class="flex gap-2">
                    <button onclick="closeSettingsModal()" class="px-3 py-1 text-sm bg-gray-200 rounded">取消</button>
                    <button onclick="saveSettings()" class="px-3 py-1 text-sm bg-indigo-600 text-white rounded">儲存</button>
                </div>
            </div>
        </div>
    </div>

    <div id="floatingCalc" class="floating-calc hidden">
        <div class="calc-toggle" onclick="toggleCalc()"><i class="fa-solid fa-calculator"></i> 收合</div>
        <input type="text" id="calcDisplay" readonly class="calc-display w-full" value="0">
        <div class="grid grid-cols-4 gap-2">
            <button onclick="calcClear()" class="calc-btn col-span-2 bg-red-600 rounded text-white font-bold">AC</button>
            <button onclick="calcDelete()" class="calc-btn bg-gray-600 rounded text-white"><i class="fa-solid fa-delete-left"></i></button>
            <button onclick="calcAppend('/')" class="calc-btn bg-orange-600 rounded text-white">÷</button>
            <button onclick="calcAppend('7')" class="calc-btn bg-gray-700 rounded text-white">7</button>
            <button onclick="calcAppend('8')" class="calc-btn bg-gray-700 rounded text-white">8</button>
            <button onclick="calcAppend('9')" class="calc-btn bg-gray-700 rounded text-white">9</button>
            <button onclick="calcAppend('*')" class="calc-btn bg-orange-600 rounded text-white">×</button>
            <button onclick="calcAppend('4')" class="calc-btn bg-gray-700 rounded text-white">4</button>
            <button onclick="calcAppend('5')" class="calc-btn bg-gray-700 rounded text-white">5</button>
            <button onclick="calcAppend('6')" class="calc-btn bg-gray-700 rounded text-white">6</button>
            <button onclick="calcAppend('-')" class="calc-btn bg-orange-600 rounded text-white">-</button>
            <button onclick="calcAppend('1')" class="calc-btn bg-gray-700 rounded text-white">1</button>
            <button onclick="calcAppend('2')" class="calc-btn bg-gray-700 rounded text-white">2</button>
            <button onclick="calcAppend('3')" class="calc-btn bg-gray-700 rounded text-white">3</button>
            <button onclick="calcAppend('+')" class="calc-btn bg-orange-600 rounded text-white">+</button>
            <button onclick="calcAppend('0')" class="calc-btn col-span-2 bg-gray-700 rounded text-white">0</button>
            <button onclick="calcAppend('.')" class="calc-btn bg-gray-700 rounded text-white">.</button>
            <button onclick="calcResult()" class="calc-btn bg-blue-600 rounded text-white">=</button>
        </div>
    </div>
    <button onclick="toggleCalc()" id="showCalcBtn" class="fixed bottom-5 right-5 w-12 h-12 bg-gray-800 text-white rounded-full shadow-lg flex items-center justify-center z-50"><i class="fa-solid fa-calculator"></i></button>

    <script>
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('.date-input').forEach(el => el.value = today);
        function uuid() { return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9); }

        const DEFAULT_URL = 'https://script.google.com/macros/s/AKfycbya7d1pikyQTO7EEpQOjDmb0Dykv9jO9G_rzRHEuhgyULHfg1oJAn6gS3I7Msw32l6ISA/exec';
        let GAS_URL = localStorage.getItem('building_gas_url');
        if (!GAS_URL) { GAS_URL = DEFAULT_URL; localStorage.setItem('building_gas_url', GAS_URL); }

        let currentFilter = 'all';

        let records = JSON.parse(localStorage.getItem('building_records') || '[]');
        
        // --- 強制清除舊的預設資料 ---
        const initialLen = records.length;
        records = records.filter(r => {
            if (r.id === 'fixed-init-balance-2025' || r.id === 'fixed-sample-parking') return false;
            if (r.type === '初始餘額' && r.desc === '上年度餘額' && r.balance == 378129) return false;
            if (r.type === '車位租借' && r.desc && r.desc.includes('車位 31 (2-2)')) return false;
            return true;
        });

        if (records.length !== initialLen) {
            localStorage.setItem('building_records', JSON.stringify(records));
        }
        // ------------------------------

        if (records.length === 0) {
            // 已清空，不再自動產生預設資料
        }

        updateTotalBalanceDisplay();
        renderRecords();
        if (GAS_URL) downloadFromCloud(true); 

        document.addEventListener("visibilitychange", function() {
            if (!document.hidden && GAS_URL) downloadFromCloud(true);
        });

        // --- Core Functions ---
        async function downloadFromCloud(silent = false) {
            if (!GAS_URL) return;
            const btn = document.getElementById('headerSyncBtn');
            const txt = document.getElementById('headerSyncText');
            const icon = document.getElementById('syncIcon');
            if(!silent) { icon.className = "fa-solid fa-spinner fa-spin"; txt.textContent = "更新中..."; }

            try {
                const response = await fetch(`${GAS_URL}?t=${new Date().getTime()}`, { method: 'GET', redirect: 'follow' });
                if (!response.ok) throw new Error("HTTP " + response.status);
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("text/html")) throw new Error("Apps Script 未更新 (HTML Error)");
                const cloudData = await response.json();
                
                let localRecords = JSON.parse(localStorage.getItem('building_records') || '[]');
                const localMap = new Map(localRecords.map(r => [r.id, r]));
                let updateCount = 0;
                
                cloudData.forEach(cloudRecord => {
                    if (localMap.has(cloudRecord.id)) {
                        const localRecord = localMap.get(cloudRecord.id);
                        if (localRecord.synced) { 
                            localMap.set(cloudRecord.id, { ...cloudRecord, synced: true });
                            updateCount++;
                        }
                    } else {
                        localMap.set(cloudRecord.id, { ...cloudRecord, synced: true });
                        updateCount++;
                    }
                });

                let newRecords = Array.from(localMap.values());
                newRecords.sort((a, b) => { 
                    const d = new Date(a.date) - new Date(b.date);
                    return d !== 0 ? d : new Date(a.timestamp) - new Date(b.timestamp);
                });

                localStorage.setItem('building_records', JSON.stringify(newRecords));
                renderRecords(); updateTotalBalanceDisplay(); checkSyncStatus();
                if (!silent && updateCount > 0) alert(`已從雲端還原 ${updateCount} 筆資料！`);
                
            } catch (e) {
                console.error(e);
                if (!silent) alert("讀取失敗，請檢查設定: " + e.message);
            } finally { checkSyncStatus(); }
        }

        async function sendToSheet(record, form, action = 'create') {
            if (!GAS_URL) return;
            const btn = form ? form.querySelector('button[type="submit"]') : null;
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 上傳中'; }
            
            const payload = { ...record, action: action };
            if (payload.last3) payload.last3 = "'" + payload.last3;

            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                record.synced = true;
                saveToLocal(record);
                if(action === 'create') alert('成功！');
                setTimeout(() => downloadFromCloud(true), 800); 
            } catch (e) {
                alert('上傳失敗');
            } finally {
                if (btn) {
                    if (form.id === 'form-fee') btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>提交管理費';
                    else if (form.id === 'form-parking') btn.innerHTML = '<i class="fa-solid fa-car mr-2"></i>登記車位';
                    else btn.innerHTML = '<i class="fa-solid fa-pen-to-square mr-2"></i>記錄雜支';
                    btn.disabled = false;
                    form.reset();
                    if(form.querySelector('.date-input')) form.querySelector('.date-input').value = today;
                }
                renderRecords(); checkSyncStatus();
            }
        }

        function checkSyncStatus() {
            const rs = JSON.parse(localStorage.getItem('building_records') || '[]');
            const pending = rs.filter(r => !r.synced);
            const btn = document.getElementById('headerSyncBtn');
            const icon = document.getElementById('syncIcon');
            const txt = document.getElementById('headerSyncText');
            
            if (pending.length > 0) {
                btn.className = "flex items-center gap-2 px-3 py-1.5 rounded bg-orange-600 hover:bg-orange-500 text-white shadow-md animate-pulse";
                icon.className = "fa-solid fa-cloud-arrow-up"; txt.textContent = `未同步 (${pending.length})`;
            } else {
                btn.className = "flex items-center gap-2 px-3 py-1.5 rounded bg-indigo-800 hover:bg-indigo-700 text-gray-200";
                icon.className = "fa-solid fa-cloud"; txt.textContent = "已同步";
            }
        }

        function handleSyncClick() {
            const rs = JSON.parse(localStorage.getItem('building_records') || '[]');
            const pending = rs.filter(r => !r.synced);
            if (pending.length > 0) syncPendingRecords();
            else downloadFromCloud(false);
        }

        async function syncPendingRecords() {
            const rs = JSON.parse(localStorage.getItem('building_records') || '[]');
            const pending = rs.filter(r => !r.synced);
            if (pending.length === 0) return;
            
            document.getElementById('headerSyncText').textContent = "上傳中...";
            for (let record of pending) {
                await sendToSheet(record, null, 'update');
                await new Promise(r => setTimeout(r, 400));
            }
            downloadFromCloud(false);
        }

        // --- Helpers ---
        let editingId = null;
        function saveToLocal(record) {
            let rs = JSON.parse(localStorage.getItem('building_records') || '[]');
            const idx = rs.findIndex(r => r.id === record.id);
            if (idx !== -1) rs[idx] = record; else rs.push(record);
            rs.sort((a, b) => {
                const d = new Date(a.date) - new Date(b.date);
                return d !== 0 ? d : new Date(a.timestamp) - new Date(b.timestamp);
            });
            localStorage.setItem('building_records', JSON.stringify(rs));
            checkSyncStatus();
        }

        async function handleSubmit(event, type) {
            event.preventDefault();
            const form = event.target;
            const data = Object.fromEntries(new FormData(form));
            const newRecord = {
                id: editingId ? editingId : uuid(),
                timestamp: new Date().toLocaleString('zh-TW'),
                date: data.date, type: type,
                income: 0, expense: 0,
                last3: String(data.last3 || '').trim(), desc: '', synced: false
            };
            
            if (type === '管理費') { newRecord.desc = `${data.period} (${data.unit})`; newRecord.income = parseInt(data.amount) || 0; }
            else if (type === '車位租借') { newRecord.desc = `車位 ${data.unit} (${data.renter})`; newRecord.income = parseInt(data.amount) || 0; }
            else { newRecord.desc = data.summary; newRecord.income = parseInt(data.income)||0; newRecord.expense = parseInt(data.expense)||0; }

            saveToLocal(newRecord); updateTotalBalanceDisplay();
            if(editingId) { cancelEdit(); syncPendingRecords(); }
            else { sendToSheet(newRecord, form, 'create'); }
        }

        function calculateBalances(list) {
            let sorted = [...list].sort((a, b) => {
                const d = new Date(a.date) - new Date(b.date);
                return d !== 0 ? d : new Date(a.timestamp) - new Date(b.timestamp);
            });
            let bal = 0;
            return sorted.map(r => {
                const inc = parseInt(r.income)||0; const exp = parseInt(r.expense)||0;
                if(r.type==='初始餘額') bal = parseInt(r.balance)||0;
                else bal = bal + inc - exp;
                return { ...r, currentBalance: bal };
            });
        }

        function renderRecords() {
            const tbody = document.getElementById('recordsTableBody');
            const month = document.getElementById('monthFilter').value;
            let list = calculateBalances(JSON.parse(localStorage.getItem('building_records') || '[]'));
            let filtered = list.filter(r => {
                // 排除已刪除的資料
                if (r.desc && r.desc.includes('(已刪除)')) return false;
                if (currentFilter!=='all' && r.type!==currentFilter) return false;
                if (month && !r.date.startsWith(month)) return false;
                return true;
            });
            
            tbody.innerHTML = '';
            document.getElementById('noDataMsg').classList.toggle('hidden', filtered.length > 0);
            
            filtered.forEach(r => {
                const tr = document.createElement('tr');
                const inc = r.income>0 ? `<span class="text-green-600">+$${r.income}</span>` : '';
                const exp = r.expense>0 ? `<span class="text-red-500">-$${r.expense}</span>` : '';
                const bal = `$${(r.currentBalance||0).toLocaleString()}`;
                const l3 = (r.last3||'').replace(/^'/,'');
                let badge = 'bg-gray-100';
                if(r.type==='管理費') badge='bg-indigo-100 text-indigo-800';
                if(r.type==='車位租借') badge='bg-green-100 text-green-800';
                
                let icon = r.synced ? '<span class="text-green-500"><i class="fa-solid fa-check"></i></span>' : '<span class="text-orange-500"><i class="fa-solid fa-arrow-up"></i></span>';
                let action = '';
                if (r.type!=='初始餘額') {
                    action = `
                        <button onclick="editRecord('${r.id}')" class="text-indigo-600 bg-indigo-50 px-2 py-1 rounded text-xs hover:bg-indigo-100 mr-1">修改</button>
                        <button onclick="deleteRecord('${r.id}')" class="text-red-600 bg-red-50 px-2 py-1 rounded text-xs hover:bg-red-100">刪除</button>
                    `;
                }

                tr.innerHTML = `<td class="px-2 py-3 text-gray-600">${r.date}</td><td class="px-2 py-3"><span class="text-xs font-bold mr-1 ${badge} px-1 rounded">${r.type}</span>${r.desc}</td><td class="px-2 py-3 text-right font-medium">${inc}</td><td class="px-2 py-3 text-right font-medium">${exp}</td><td class="px-2 py-3 text-right font-bold text-gray-700">${bal}</td><td class="px-2 py-3 text-xs">${l3}</td><td class="px-2 py-3 text-center">${icon}</td><td class="px-2 py-3 text-center whitespace-nowrap">${action}</td>`;
                tbody.appendChild(tr);
            });
        }

        // 新增刪除功能
        function deleteRecord(id) {
            if(!confirm('確定要刪除這筆資料嗎？\n(這將會把金額歸零並標記為已刪除，然後同步到雲端)')) return;
            
            let rs = JSON.parse(localStorage.getItem('building_records') || '[]');
            const index = rs.findIndex(r => r.id === id);
            if(index !== -1) {
                // 標記為刪除 (修改內容)
                let record = rs[index];
                record.desc = `(已刪除) ${record.desc}`;
                record.income = 0;
                record.expense = 0;
                record.synced = false; // 標記未同步以觸發上傳
                
                // 更新本地
                rs[index] = record;
                localStorage.setItem('building_records', JSON.stringify(rs));
                
                // 立即同步
                syncPendingRecords();
                renderRecords();
                updateTotalBalanceDisplay();
            }
        }

        // 清除重複資料功能
        function cleanDuplicates() {
            if(!confirm("這將會移除內容完全相同(日期/類型/描述/金額)的重複資料，只保留一筆。\n\n確定執行？")) return;
            
            let rs = JSON.parse(localStorage.getItem('building_records') || '[]');
            const uniqueMap = new Map();
            let removedCount = 0;

            rs.forEach(r => {
                // 建立唯一鍵值：日期+類型+描述+收入+支出
                const key = `${r.date}|${r.type}|${r.desc}|${r.income}|${r.expense}`;
                if (uniqueMap.has(key)) {
                    // 如果已存在，檢查誰是「已同步」的，優先保留已同步的
                    const existing = uniqueMap.get(key);
                    if (!existing.synced && r.synced) {
                        uniqueMap.set(key, r); // 替換為已同步版本
                    }
                    // 否則保留原有的 (視為重複)
                    removedCount++;
                } else {
                    uniqueMap.set(key, r);
                }
            });

            if (removedCount > 0) {
                const newRecords = Array.from(uniqueMap.values());
                newRecords.sort((a, b) => { 
                    const d = new Date(a.date) - new Date(b.date);
                    return d !== 0 ? d : new Date(a.timestamp) - new Date(b.timestamp);
                });
                localStorage.setItem('building_records', JSON.stringify(newRecords));
                renderRecords();
                updateTotalBalanceDisplay();
                alert(`已移除 ${removedCount} 筆重複資料！`);
                closeSettingsModal();
            } else {
                alert("未發現重複資料。");
            }
        }

        // 新增：刪除未同步資料
        function deleteUnsyncedRecords() {
            if(!confirm("確定要刪除所有「未同步」的資料嗎？\n這將會遺失尚未上傳到雲端的本機新增/修改紀錄。\n\n此動作無法復原！")) return;

            let rs = JSON.parse(localStorage.getItem('building_records') || '[]');
            const originalLength = rs.length;
            // 只保留已同步的
            const newRs = rs.filter(r => r.synced === true);
            const deletedCount = originalLength - newRs.length;

            if (deletedCount === 0) {
                alert("沒有發現未同步的資料。");
                return;
            }

            localStorage.setItem('building_records', JSON.stringify(newRs));
            renderRecords();
            updateTotalBalanceDisplay();
            checkSyncStatus();
            
            alert(`已刪除 ${deletedCount} 筆未同步的資料。`);
            closeSettingsModal();
        }

        function updateTotalBalanceDisplay() {
            const rs = JSON.parse(localStorage.getItem('building_records') || '[]');
            const calculated = calculateBalances(rs);
            if (calculated.length > 0) {
                const latest = calculated[calculated.length - 1]; 
                const bal = latest.currentBalance;
                document.getElementById('totalBalanceDisplay').textContent = (bal !== undefined && !isNaN(bal)) ? `$${bal.toLocaleString()}` : '$0';
            } else {
                document.getElementById('totalBalanceDisplay').textContent = '$0';
            }
        }

        // Other UI
        // let currentFilter='all'; // Removed from here
        function filterRecords(t) { currentFilter=t; document.querySelectorAll('.filter-btn').forEach(b=>b.className='filter-btn px-3 py-1 text-xs rounded text-gray-500 hover:bg-gray-200'); if(document.getElementById('filter-'+(t==='all'?'all':(t==='管理費'?'fee':(t==='車位租借'?'parking':'misc'))))) document.getElementById('filter-'+(t==='all'?'all':(t==='管理費'?'fee':(t==='車位租借'?'parking':'misc')))).className='filter-btn px-3 py-1 text-xs rounded bg-white shadow text-indigo-600 font-bold'; renderRecords(); }
        function editRecord(id) {
            const r = JSON.parse(localStorage.getItem('building_records')).find(x=>x.id===id);
            if(!r) return;
            editingId = id;
            document.getElementById('editModeBanner').classList.remove('hidden');
            let t = r.type==='管理費'?'fee':(r.type==='車位租借'?'parking':'misc');
            switchTab(t);
            const f = document.getElementById('form-'+t);
            if(f.querySelector('[name="date"]')) f.querySelector('[name="date"]').value=r.date;
            if(f.querySelector('[name="last3"]')) f.querySelector('[name="last3"]').value=r.last3;
            if(t==='fee') { const m=r.desc.match(/(.+) \((.+)\)/); if(m){f.querySelector('[name="period"]').value=m[1]; f.querySelector('[name="unit"]').value=m[2];} }
            else if(t==='parking') { const m=r.desc.match(/車位 (.+) \((.+)\)/); if(m){f.querySelector('[name="unit"]').value=m[1]; f.querySelector('[name="renter"]').value=m[2]; updateParkingPrice();} }
            else { f.querySelector('[name="summary"]').value=r.desc; f.querySelector('[name="income"]').value=r.income; f.querySelector('[name="expense"]').value=r.expense; }
            document.getElementById(`tab-${t}`).classList.add('editing-mode');
        }
        function switchTab(t) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden-tab')); document.querySelectorAll('.tab-btn').forEach(e=>{e.classList.remove('bg-indigo-100','text-indigo-700');e.classList.add('text-gray-500');}); document.getElementById(`tab-${t}`).classList.remove('hidden-tab'); document.getElementById(`btn-${t}`).classList.add('bg-indigo-100','text-indigo-700'); if(t==='records') filterRecords('all'); }
        function updateParkingPrice() { const s=document.getElementById('parkingSpotSelect').value; document.getElementById('parkingPrice').value = s==='11'?200:(s?800:''); }
        
        // Settings
        function openSettingsModal() { document.getElementById('settingsModal').classList.remove('hidden'); document.getElementById('gasUrlInput').value=GAS_URL; }
        function closeSettingsModal() { document.getElementById('settingsModal').classList.add('hidden'); }
        function saveSettings() { const u=document.getElementById('gasUrlInput').value.trim(); if(u){localStorage.setItem('building_gas_url',u); GAS_URL=u; alert('已儲存'); closeSettingsModal(); downloadFromCloud(false);} }
        function forceDownload() { downloadFromCloud(false); closeSettingsModal(); }
        function resetSyncStatus() { let rs=JSON.parse(localStorage.getItem('building_records')||'[]'); rs.forEach(r=>r.synced=false); localStorage.setItem('building_records',JSON.stringify(rs)); checkSyncStatus(); renderRecords(); alert('狀態已重置'); }

        // Calc
        let calcVal='0'; const display=document.getElementById('calcDisplay');
        function toggleCalc() { const c=document.getElementById('floatingCalc'); const b=document.getElementById('showCalcBtn'); if(c.classList.contains('hidden')){c.classList.remove('hidden');b.classList.add('hidden');}else{c.classList.add('hidden');b.classList.remove('hidden');} }
        function calcAppend(v) { if(calcVal==='0' && v!=='.') calcVal=v; else calcVal+=v; display.value=calcVal; }
        function calcClear() { calcVal='0'; display.value='0'; }
        function calcDelete() { calcVal=calcVal.length>1?calcVal.slice(0,-1):'0'; display.value=calcVal; }
        function calcResult() { try{calcVal=String(Function('"use strict";return ('+calcVal+')')());display.value=calcVal;}catch{display.value='Error';setTimeout(calcClear,1000);} }
        
    </script>
</body>
</html>